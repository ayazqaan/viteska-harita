<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Viteska – Yetkili Servis & Bayi Harita</title>
  <style>
    :root {
      --color-primary: #f27405;
      --color-accent: #db6000;
      --color-blue: #3483fa;
      --color-bg: #fff;
      --color-border: #ffe2c2;
      --font: 'Segoe UI', sans-serif;
    }
    html, body {
      margin: 0; padding: 0;
      font-family: var(--font);
      background: var(--color-bg);
      width: 100vw; height: 100vh;
      min-height: 100vh;
      overflow: hidden;
    }
    #mapWrap {width:100vw; height:100vh; position:relative;}
    #map { width: 100vw; height: 100vh; border-radius: 0; box-shadow: none;}
    .info-strip {
      position: absolute; left: 50%; top: 13px; transform: translateX(-50%);
      background: #fff8f2d8; color: #9b590a; padding: 7px 18px; border-radius: 19px; box-shadow: 0 1px 9px #ffc98a3c;
      font-weight: 700; font-size: 1.04em; z-index: 99; display: flex; gap: 20px; align-items: center;
      border: 1.5px solid #ffe2c2;
    }
    .info-dot {width:15px; height:15px; border-radius:50%; display:inline-block; margin-right:5px;}
    .dot-orange {background: var(--color-primary);}
    .dot-blue {background: var(--color-blue);}
    #mapLoading {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
      background: #fff3eb; color: #c86e01; font-weight: 600; font-size: 1.13em;
      padding: 22px 28px; border-radius: 14px; z-index: 222; box-shadow: 0 3px 22px #ffc98a38;
    }
    /* Modal (Popup) */
    .modal-bg {
      display: none; position:fixed; left:0;top:0;width:100vw;height:100vh;z-index:9999;
      background: rgba(41,18,0,0.34);
      align-items: center; justify-content: center;
      transition: opacity .18s;
    }
    .modal-bg.active { display:flex; animation:fadein .22s; }
    @keyframes fadein {0%{opacity:0;} 100%{opacity:1;}}
    .modal-inner {
      background: #fff7ee;
      border-radius: 14px;
      padding: 23px 17px 13px 17px;
      min-width: 300px;
      max-width: 95vw;
      box-shadow: 0 7px 36px #d2630040;
      position: relative;
      animation: pop .16s;
    }
    @keyframes pop {0%{transform:scale(.92);} 100%{transform:scale(1);}}
    .modal-close {
      position:absolute; right:11px; top:9px; background:none; border:none; font-size:2.0em; color:#e07000; cursor:pointer; z-index:9;
      line-height:1; font-weight:700;
    }
    .place-photo {width: 100%; max-height: 210px; border-radius: 11px; object-fit: cover; margin-bottom: 10px;}
    .modal-main-title {font-size: 1.23em; font-weight:700; color: var(--color-primary); margin-bottom: 6px;}
    .place-rating {font-weight: 700; color: #e08e1e;}
    .place-status {font-weight: 700; margin-left: 10px;}
    .place-status.open {color: #1aa331;}
    .place-status.closed {color: #e53935;}
    .place-link {display: inline-block; margin-top: 8px; color: #007aff;}
    .modal-btn {
      background: var(--color-primary); color:#fff; border:none;
      padding: 8px 18px; border-radius: 9px; font-weight:600; font-size:1.08em;
      margin-right:8px; margin-top:9px; cursor:pointer; box-shadow:none; outline:none;
      display: inline-block;
    }
    .modal-btn:active { background: #db6000; }
    .directions-panel {
      margin: 10px 0 0 0;
      background: #fffaec;
      padding: 7px 12px;
      border-radius: 8px;
      font-size: 1.03rem;
      color: #b1790d;
    }
    @media (max-width: 700px) {
      .modal-inner { min-width: 0; max-width: 99vw;}
    }
  </style>
</head>
<body>
<div id="mapWrap">
  <div id="map"></div>
  <div class="info-strip">
    <span class="info-dot dot-orange"></span> Yetkili Servis
    <span class="info-dot dot-blue"></span> Bayi
  </div>
  <div id="mapLoading" class="loading" style="display:none;">Harita yükleniyor...</div>
</div>
<div class="modal-bg" id="modalBg"></div>
<script>
let map, placesServis = [], placesBayi = [], markers = [], userPos = null, directionsService, directionsRenderer;

// HARİTA BAŞLATICI
function initMap() {
  document.getElementById('mapLoading').style.display = '';
  navigator.geolocation.getCurrentPosition(pos => {
    userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    map = new google.maps.Map(document.getElementById('map'), {
      center: userPos, zoom: 13, mapTypeControl: false, streetViewControl: false, fullscreenControl: false
    });
    // Kullanıcı konumu marker
    new google.maps.Marker({
      map, position: userPos,
      icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#14a001", fillOpacity: 1, strokeColor: "#fff", strokeWeight: 2 },
      title: "Şu anki konumun"
    });
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true, polylineOptions: { strokeColor: "#db6000", strokeWeight: 5 } });
    directionsRenderer.setMap(map);

    // SADECE OTOMOTİV YETKİLİ SERVİS ve BAYİ
    const placesService = new google.maps.places.PlacesService(map);
    // Yetkili Servis
    placesService.nearbySearch({
      location: userPos,
      radius: 30000,
      keyword: "oto yetkili servis",
      type: "car_repair"
    }, (results, status) => {
      if (status === google.maps.places.PlacesServiceStatus.OK) {
        placesServis = results.filter(place =>
          /(oto|otomobil|araba|car)/i.test(place.name + " " + (place.types||[]).join(" "))
        );
        renderMarkers();
      }
    });
    // Bayi
    placesService.nearbySearch({
      location: userPos,
      radius: 30000,
      keyword: "otomobil bayi",
      type: "car_dealer"
    }, (results, status) => {
      if (status === google.maps.places.PlacesServiceStatus.OK) {
        placesBayi = results.filter(place =>
          /(oto|otomobil|araba|car)/i.test(place.name + " " + (place.types||[]).join(" "))
        );
        renderMarkers();
      }
    });
    document.getElementById('mapLoading').style.display = 'none';
  }, ()=>{
    alert('Konum alınamadı. Lütfen konum izni verin.');
    document.getElementById('mapLoading').style.display = 'none';
  });
}

// MARKERLARI GÖSTER
function renderMarkers() {
  markers.forEach(m => m.setMap(null)); markers = [];
  if(!map) return;
  // Yetkili Servis (turuncu)
  placesServis.forEach(place => {
    const marker = new google.maps.Marker({
      map, position: place.geometry.location, title: place.name,
      icon: { path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW, scale: 6, fillColor: "#f27405", fillOpacity: 1, strokeWeight: 1, strokeColor: "#fff" }
    });
    marker.addListener('click', ()=>showPlaceDetail(place.place_id, 'servis'));
    markers.push(marker);
  });
  // Bayi (mavi)
  placesBayi.forEach(place => {
    const marker = new google.maps.Marker({
      map, position: place.geometry.location, title: place.name,
      icon: { path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW, scale: 6, fillColor: "#3483fa", fillOpacity: 1, strokeWeight: 1, strokeColor: "#fff" }
    });
    marker.addListener('click', ()=>showPlaceDetail(place.place_id, 'bayi'));
    markers.push(marker);
  });
}

// DETAYLI POPUP VE ROTA
function showPlaceDetail(placeId, type) {
  const modalBg = document.getElementById('modalBg');
  modalBg.innerHTML = `<div class="modal-inner"><div style="padding:29px 0; text-align:center;">Yükleniyor...</div></div>`;
  modalBg.classList.add('active');
  const placesService = new google.maps.places.PlacesService(map);
  placesService.getDetails({
    placeId,
    fields: ['name','rating','photos','formatted_address','vicinity','formatted_phone_number','website','opening_hours','geometry','types']
  }, (place, status)=>{
    if(status !== google.maps.places.PlacesServiceStatus.OK) return;
    let photoUrl = place.photos && place.photos[0] ? place.photos[0].getUrl({maxWidth:410,maxHeight:210}) : '';
    let isOpen = place.opening_hours && typeof place.opening_hours.isOpen === 'function' ? place.opening_hours.isOpen() : undefined;
    let rating = place.rating ? `<span class="place-rating">★ ${place.rating.toFixed(1)}</span>` : '';
    let openHtml = (isOpen !== undefined) ? `<span class="place-status ${isOpen?'open':'closed'}">${isOpen?'Açık':'Kapalı'}</span>` : '';
    let website = place.website ? `<a href="${place.website}" class="place-link" target="_blank">Web Sitesi</a>` : '';
    let phone = place.formatted_phone_number ? `<a href="tel:${place.formatted_phone_number.replace(/\s+/g,'')}" class="modal-btn" style="background:#ececec; color:#e36901; margin-top:4px; font-weight:600;">Ara</a>` : '';
    let address = place.formatted_address || place.vicinity || '';
    let directionsBtn = `<button class="modal-btn" style="margin-top:9px;" onclick="calcRoute(${place.geometry.location.lat()},${place.geometry.location.lng()},'${place.name.replace(/'/g,"\\'")}')">Rota Oluştur</button>`;

    modalBg.innerHTML = `
      <div class="modal-inner">
        <button class="modal-close" onclick="closeModal()">×</button>
        <div class="modal-content">
          ${photoUrl?`<img src="${photoUrl}" class="place-photo" alt="Servis Görseli">`:""}
          <div class="modal-main-title">${place.name||''}</div>
          <div>${rating}${openHtml}</div>
          <div class="modal-detail" style="margin-top:8px;"><b>Adres:</b> ${address}</div>
          ${place.formatted_phone_number?`<div class="modal-city"><b>Telefon:</b> ${place.formatted_phone_number}</div>`:""}
          <div class="modal-actions">
            ${directionsBtn}
            ${website}
            ${phone}
          </div>
          <div id="directionsPanel"></div>
        </div>
      </div>
    `;
  });
}
window.closeModal = function(){
  document.getElementById('modalBg').classList.remove('active');
  setTimeout(()=>{document.getElementById('modalBg').innerHTML='';}, 300);
};
window.calcRoute = function(destLat, destLng, destName){
  if(!userPos){ alert('Konum alınamadı.'); return; }
  const request = {
    origin: userPos,
    destination: { lat: destLat, lng: destLng },
    travelMode: google.maps.TravelMode.DRIVING
  };
  directionsService.route(request, (result, status)=>{
    if(status === google.maps.DirectionsStatus.OK){
      directionsRenderer.setDirections(result);
      const route = result.routes[0].legs[0];
      document.getElementById('directionsPanel').innerHTML = `
        <div class="directions-panel">
          <b>Mesafe:</b> ${route.distance.text} &nbsp;&nbsp; <b>Süre:</b> ${route.duration.text}
        </div>
      `;
    }
  });
};
window.initMap = initMap;
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-MpFcUMdFif1OPAGWcBhmWjWDPaM7Qz0&libraries=places&callback=initMap" async defer></script>
</body>
</html>
